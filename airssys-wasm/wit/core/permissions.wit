package airssys:core@1.0.0;

// ═════════════════════════════════════════════════════════════════════════════
// PERMISSION SYSTEM INTERFACE
// ═════════════════════════════════════════════════════════════════════════════
//
// This interface defines WIT permission types that match the Rust permission
// system for Component.toml manifest integration. It provides bidirectional
// type conversion between WIT and Rust permission structures.
//
// Note: This interface complements capabilities.wit by providing manifest-level
// permission declarations, while capabilities.wit defines runtime permission
// checking and results.

interface permissions {
    use types.{component-id};
    
    // ─────────────────────────────────────────────────────────────────────────
    // Permission Manifest
    // ─────────────────────────────────────────────────────────────────────────
    
    /// Complete permission manifest for a component
    ///
    /// This structure matches the Rust PermissionManifest type and represents
    /// all permissions declared in Component.toml.
    record permission-manifest {
        filesystem: filesystem-permissions,
        network: network-permissions,
        storage: storage-permissions,
    }
    
    // ─────────────────────────────────────────────────────────────────────────
    // Filesystem Permissions
    // ─────────────────────────────────────────────────────────────────────────
    
    /// Filesystem operation permissions with glob pattern support
    ///
    /// Uses glob patterns for flexible path-based access control:
    /// - `*` matches any characters except `/` (single level)
    /// - `**` matches any characters including `/` (recursive)
    /// - `?` matches single character
    record filesystem-permissions {
        /// File read permissions (glob patterns)
        read: list<string>,
        /// File write permissions (glob patterns)
        write: list<string>,
        /// File delete permissions (glob patterns)
        delete: list<string>,
        /// Directory list permissions (glob patterns)
        list-dir: list<string>,
    }
    
    // ─────────────────────────────────────────────────────────────────────────
    // Network Permissions
    // ─────────────────────────────────────────────────────────────────────────
    
    /// Network endpoint definition (host + port)
    ///
    /// Supports:
    /// - Exact domains: "api.example.com"
    /// - Wildcard subdomains: "*.example.com"
    /// - IPv4: "192.168.1.100"
    /// - IPv6: "[2001:db8::1]"
    record network-endpoint {
        /// Host domain or IP address
        host: string,
        /// Port number (1-65535)
        port: u16,
    }
    
    /// Network operation permissions
    ///
    /// Uses wildcard domain matching and port specifications for network
    /// access control.
    record network-permissions {
        /// Outbound connection permissions (host + port)
        outbound: list<network-endpoint>,
        /// Inbound listening permissions (ports only)
        inbound: list<u16>,
    }
    
    // ─────────────────────────────────────────────────────────────────────────
    // Storage Permissions
    // ─────────────────────────────────────────────────────────────────────────
    
    /// Storage operation permissions
    ///
    /// Uses namespace-based access control with quota enforcement.
    /// Namespace format: "prefix:name" (e.g., "myapp:cache")
    record storage-permissions {
        /// Storage namespace permissions
        namespaces: list<string>,
        /// Total storage quota in megabytes
        max-size-mb: u64,
    }
    
    // ─────────────────────────────────────────────────────────────────────────
    // Permission Check Result
    // ─────────────────────────────────────────────────────────────────────────
    
    /// Permission check result
    ///
    /// Used by host function implementations to return permission check results.
    variant permission-result {
        /// Permission granted
        granted,
        /// Permission denied with reason
        denied(string),
    }
    
    // ─────────────────────────────────────────────────────────────────────────
    // Permission Checking Functions (Host Implementation)
    // ─────────────────────────────────────────────────────────────────────────
    
    /// Check if component can read a file
    check-file-read: func(component: component-id, path: string) -> permission-result;
    
    /// Check if component can write a file
    check-file-write: func(component: component-id, path: string) -> permission-result;
    
    /// Check if component can delete a file
    check-file-delete: func(component: component-id, path: string) -> permission-result;
    
    /// Check if component can list a directory
    check-directory-list: func(component: component-id, path: string) -> permission-result;
    
    /// Check if component can make outbound network connection
    check-network-outbound: func(component: component-id, host: string, port: u16) -> permission-result;
    
    /// Check if component can access storage namespace
    check-storage-access: func(component: component-id, namespace: string) -> permission-result;
}
