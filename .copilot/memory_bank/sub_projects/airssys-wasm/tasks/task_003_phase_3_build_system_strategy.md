# airssys-wasm Build System Integration Strategy

**Version:** 1.0.0  
**Date:** 2025-10-25  
**For:** WASM-TASK-003 Phase 3 Implementation

---

## Executive Summary

This document defines the complete build system integration strategy for airssys-wasm, covering wit-bindgen integration, Cargo configuration, incremental builds, and Phase 3 implementation approach.

---

## 1. Build System Architecture

### Overview

```
Source Control (WIT Files)
    ↓
build.rs (Triggered by Cargo)
    ↓
Stage 1: WIT Validation (wasm-tools)
    ↓
Stage 2: Binding Generation (wit-bindgen)
    ↓
Generated Bindings (src/generated/)
    ↓
Rust Compilation (rustc)
    ↓
Core WASM Module (.wasm)
    ↓
Componentization (wasm-tools component new)
    ↓
Final Component (.component.wasm)
```

### Key Design Decisions

**Decision 1: CLI vs Macro**
- **Choice:** CLI-based binding generation in build.rs
- **Rationale:** Better reliability, visibility, and debugging

**Decision 2: Generation Scope**
- **Choice:** All 7 packages in single invocation
- **Rationale:** Ensures type consistency and correct dependency resolution

**Decision 3: Output Location**
- **Choice:** `src/generated/` directory
- **Rationale:** Clear separation from hand-written code, easy to .gitignore

**Decision 4: Rebuild Triggers**
- **Choice:** `cargo:rerun-if-changed=wit/`
- **Rationale:** Minimize unnecessary regeneration while catching all WIT changes

---

## 2. build.rs Design

### Responsibilities

1. **Validation:** Validate all WIT files before generation
2. **Generation:** Invoke wit-bindgen to create Rust bindings
3. **Error Handling:** Provide clear error messages on failures
4. **Incremental Builds:** Only regenerate when WIT changes
5. **Dependency Tracking:** Inform Cargo of rebuild triggers

### Implementation Strategy

**Two-Stage Process:**

**Stage 1: Validation (wasm-tools)**
- Validates WIT syntax and semantics
- Checks for circular dependencies
- Provides better error messages than wit-bindgen
- Fast fail if WIT is invalid

**Stage 2: Generation (wit-bindgen)**
- Generates Rust bindings from validated WIT
- Creates module structure matching packages
- Outputs to `src/generated/`
- Formats generated code with rustfmt

### Error Handling Strategy

**Validation Failures:**
```rust
if !validation_status.success() {
    eprintln!("WIT validation failed!");
    eprintln!("{}", String::from_utf8_lossy(&validation_output.stderr));
    panic!("Fix WIT errors before building");
}
```

**Generation Failures:**
```rust
if !generation_status.success() {
    eprintln!("Binding generation failed!");
    eprintln!("{}", String::from_utf8_lossy(&generation_output.stderr));
    panic!("wit-bindgen failed - see errors above");
}
```

---

## 3. Package Generation Order

### Topological Ordering

**Level 0: Foundation (No Dependencies)**
- `airssys:core-types@1.0.0`

**Level 1: Core Interfaces (Depend on Foundation)**
- `airssys:core-component@1.0.0`
- `airssys:core-capabilities@1.0.0`

**Level 2: Core Services (Depend on Core)**
- `airssys:core-host@1.0.0`

**Level 3: Extensions (Depend on Core)**
- `airssys:ext-filesystem@1.0.0`
- `airssys:ext-network@1.0.0`
- `airssys:ext-process@1.0.0`

### wit-bindgen Handling

**Key Insight:** wit-bindgen automatically handles topological sorting when given entire package tree.

**Command:**
```bash
wit-bindgen rust --out-dir src/generated --world airssys-world wit/
```

**Process:**
1. Scans wit/ directory for all packages
2. Parses deps.toml for each package
3. Builds dependency graph
4. Validates no circular dependencies
5. Generates in dependency order automatically

**No Manual Ordering Required!**

---

## 4. Generated Code Organization

### Output Structure

```
src/
├── generated/           # Generated by wit-bindgen
│   ├── airssys/
│   │   ├── core_types.rs
│   │   ├── core_component.rs
│   │   ├── core_capabilities.rs
│   │   ├── core_host.rs
│   │   └── ext/
│   │       ├── filesystem.rs
│   │       ├── network.rs
│   │       └── process.rs
│   └── lib.rs           # Generated module root
├── lib.rs               # Hand-written, imports generated
└── ... (other hand-written modules)
```

### Integration Pattern

**In src/lib.rs:**
```rust
// Include generated bindings
#[allow(warnings)]  // Generated code may have warnings
mod generated;

// Re-export for convenience
pub use generated::*;

// Hand-written implementation
pub struct AirsysWasmComponent;

impl generated::exports::airssys::core_component::component_lifecycle::Guest 
    for AirsysWasmComponent 
{
    // Implement exported interface
}

// Export component
generated::export!(AirsysWasmComponent with_types_in generated);
```

---

## 5. Rebuild Trigger Strategy

### Cargo Directives

```rust
// In build.rs
fn main() {
    // Rebuild when any WIT file changes
    println!("cargo:rerun-if-changed=wit/");
    
    // Rebuild when build.rs itself changes
    println!("cargo:rerun-if-changed=build.rs");
    
    // Optionally: specific files
    println!("cargo:rerun-if-changed=wit/core/types/types.wit");
    // ... etc for all WIT files
}
```

### Granularity Tradeoff

**Option 1: Directory-Level (`wit/`)**
- Pros: Simple, one directive
- Cons: Rebuilds on any WIT change, even unrelated files

**Option 2: File-Level (each .wit file)**
- Pros: Precise rebuild triggers
- Cons: Maintenance burden, easy to forget files

**Recommendation: Option 1 (Directory-Level)**
- Simpler to maintain
- WIT changes infrequent in practice
- Rebuild cost is low (~1-2s)

---

## 6. Incremental Build Support

### Caching Strategy

**What to Cache:**
- Generated bindings (src/generated/)
- wasm-tools validation results
- wit-bindgen output

**What NOT to Cache:**
- build.rs execution (always runs)
- Cargo build artifacts (Cargo handles this)

### cargo:rerun-if-changed Behavior

**How it works:**
- If no WIT files changed → skip build.rs execution
- If any WIT file changed → run build.rs
- build.rs regenerates bindings
- Cargo recompiles affected modules

**Performance Impact:**
- Clean build: ~2s binding generation + compile time
- Incremental (no WIT changes): ~0s binding generation
- Incremental (WIT changed): ~2s binding generation + affected modules

---

## 7. build.rs Implementation Plan

### Phase 3 Day 7 Tasks

1. **Create build.rs file**
   - Implement two-stage validation
   - Implement wit-bindgen invocation
   - Add error handling and logging

2. **Test build.rs**
   - Validate with current WIT structure
   - Test incremental builds
   - Verify generated code compiles

3. **Integration testing**
   - Test in CI environment
   - Validate cross-platform (Linux, macOS, Windows)
   - Check generated code quality

### Validation Criteria

✅ build.rs runs without errors  
✅ Generated bindings compile  
✅ Incremental builds work correctly  
✅ Error messages are clear and actionable  
✅ Cross-platform compatibility verified  

---

## 8. Cargo.toml Configuration Strategy

### Dependencies

**Runtime Dependencies:**
```toml
[dependencies]
# Core runtime dependencies
tokio = { workspace = true }
serde = { workspace = true }
thiserror = { workspace = true }

# Wasmtime for component execution
wasmtime = { version = "24.0", features = ["component-model"] }

# NO wit-bindgen dependency needed (CLI-generated bindings are self-contained)
```

**Build Dependencies:**
```toml
[build-dependencies]
# NO build dependencies needed
# build.rs invokes CLI tools directly via Command::new()
```

### Library Configuration

```toml
[lib]
crate-type = ["cdylib", "rlib"]
# cdylib for WASM component
# rlib for integration with other Rust code
```

### Features (Optional)

```toml
[features]
default = ["core"]
core = []
filesystem = []
network = []
process = []
all-extensions = ["filesystem", "network", "process"]
```

---

## 9. Error Handling and Debugging

### Error Scenarios

**Scenario 1: WIT Validation Failure**

**Detection:**
```rust
let output = Command::new("wasm-tools")
    .args(&["component", "wit", "wit/"])
    .output()?;

if !output.status.success() {
    // Handle validation error
}
```

**User Experience:**
```
error: WIT validation failed

Details:
expected ';', found '.'
    --> wit/core/types/types.wit:10:20

Fix WIT syntax errors and rebuild.
```

**Scenario 2: wit-bindgen Execution Failure**

**Detection:**
```rust
let status = Command::new("wit-bindgen")
    .args(&[...])
    .status()?;

if !status.success() {
    // Handle generation error
}
```

**User Experience:**
```
error: Binding generation failed

Ensure wit-bindgen is installed:
  cargo install wit-bindgen-cli

Current version required: 0.47.0
```

### Debugging Support

**Enable Verbose Logging:**
```rust
// In build.rs
if env::var("AIRSSYS_BUILD_VERBOSE").is_ok() {
    println!("cargo:warning=Running WIT validation...");
    println!("cargo:warning=WIT directory: {:?}", wit_dir);
}
```

**Preserve Generated Code:**
```rust
// Always output to src/generated (not target/)
// Allows inspection of generated bindings
```

---

## 10. CI/CD Integration

### Build Pipeline

**CI Steps:**
```yaml
# .github/workflows/build.yml
- name: Install wit-bindgen
  run: cargo install wit-bindgen-cli --version 0.47.0

- name: Install wasm-tools
  run: cargo install wasm-tools --version 1.240.0

- name: Validate WIT
  run: wasm-tools component wit wit/

- name: Build
  run: cargo build --release

- name: Run tests
  run: cargo test

- name: Build WASM component
  run: cargo build --target wasm32-wasip1 --release
```

### Version Locking

**Cargo.toml:**
```toml
[package.metadata.wasm-tools]
version = "1.240.0"

[package.metadata.wit-bindgen]
version = "0.47.0"
```

**CI Enforcement:**
- Pin exact tool versions
- Fail if versions mismatch
- Document required versions in README

---

## 11. Performance Optimization

### Build Time Optimization

**Strategy 1: Parallel Validation**
- Validate packages in parallel (if independent)
- Not applicable to airssys-wasm (dependencies between packages)

**Strategy 2: Caching**
- Cache generated bindings in CI
- Invalidate cache on WIT changes
- Use cargo-cache for Rust artifacts

**Strategy 3: Minimal Regeneration**
- Only regenerate when WIT changes
- Use cargo:rerun-if-changed effectively

### Expected Build Times

| Scenario | Time | Notes |
|----------|------|-------|
| Clean build (with generation) | ~10s | WIT gen ~2s + compile ~8s |
| Incremental (no WIT changes) | ~2s | Just Rust compilation |
| Incremental (WIT changed) | ~5s | Regen ~2s + affected modules ~3s |

---

## 12. Comparison with Alternatives

### Alternative 1: Macro-Based Generation

**Approach:** Use `wit_bindgen::generate!` macro

**Pros:**
- Integrated into compilation
- No build.rs needed

**Cons:**
- Slower builds (every time)
- Target compatibility issues (wasm32-wasip2)
- Less visibility into generated code

**Verdict:** ❌ Not recommended for airssys-wasm

### Alternative 2: Manual Code Generation

**Approach:** Run wit-bindgen manually, commit generated code

**Pros:**
- Fastest builds (no generation step)
- No tool dependencies in CI

**Cons:**
- Easy to forget regeneration
- Merge conflicts in generated code
- Large diffs in version control

**Verdict:** ❌ Not recommended (too error-prone)

### Alternative 3: build.rs with CLI (RECOMMENDED)

**Approach:** Current strategy - CLI invocation in build.rs

**Pros:**
- Automatic regeneration
- Clear separation of generated/hand-written
- Good error messages
- Incremental build support

**Cons:**
- Requires tools in CI
- Slightly slower than committed bindings

**Verdict:** ✅ Recommended - best balance of tradeoffs

---

## 13. Risk Mitigation

### Risk 1: wit-bindgen Version Incompatibility

**Scenario:** New wit-bindgen version breaks generation

**Mitigation:**
- Pin exact version in CI
- Document version requirements
- Test before upgrading

### Risk 2: Generated Code Doesn't Compile

**Scenario:** Generated bindings have Rust errors

**Mitigation:**
- Validate generated code in CI
- Run clippy on generated code
- Report issues to wit-bindgen upstream

### Risk 3: WIT Changes Break Build

**Scenario:** WIT syntax error breaks build.rs

**Mitigation:**
- Two-stage validation (wasm-tools first)
- Clear error messages
- Pre-commit hooks for WIT validation

---

## 14. Phase 3 Implementation Checklist

### Day 7: build.rs Implementation

- [ ] Create build.rs file
- [ ] Implement wasm-tools validation
- [ ] Implement wit-bindgen generation
- [ ] Add error handling
- [ ] Add rebuild triggers
- [ ] Test with existing WIT structure

### Day 8: Integration and Testing

- [ ] Test incremental builds
- [ ] Validate generated code compiles
- [ ] Test error scenarios
- [ ] Document build process
- [ ] CI integration

### Day 9: Validation and Documentation

- [ ] Cross-platform testing
- [ ] Performance benchmarking
- [ ] Final documentation
- [ ] README updates
- [ ] Phase 3 completion report

---

## References

- **wit-bindgen CLI:** https://github.com/bytecodealliance/wit-bindgen
- **Cargo build.rs:** https://doc.rust-lang.org/cargo/reference/build-scripts.html
- **wasm-tools:** https://github.com/bytecodealliance/wasm-tools

---

**Document Status:** ✅ Complete  
**Ready for:** Phase 3 Day 7 implementation  
**Next:** Implement build.rs.template (Deliverable 9)
